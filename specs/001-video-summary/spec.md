# Feature Specification: ClipNotes Video Summary

**Feature Branch**: `001-video-summary`  
**Created**: 2025-10-30  
**Status**: Draft  
**Input**: User description: "Build a web application called ClipNotes. It allows a user to upload a short video clip (e.g. CCTV or dashcam) and receive an automatic summary of the events in the video, generated by the Hafnia VLM API (powered by Cosmos-Reason1-7B). As a user, I want to upload a video and get a readable summary of what happened so I don’t have to watch it frame-by-frame. Functional requirements: upload .mp4 or .mkv file (<100MB, <30s duration); backend sends file to Hafnia API and receives summary; display AI response as bullet points (or JSON-formatted, if available); loading indicator while request is in flight; clean, responsive UI. Non-functional requirements: API credentials are secret and handled on server side; FastAPI backend with Python 3.11+, all packages via uv; frontend with React (Vite), styled with Tailwind + shadcn/ui."

## Constitution Alignment *(mandatory)*

- **Linting**: Backend contributions will add ClipNotes checks to the existing lint workflow by documenting `uv run ruff check` in the README and wiring CI to block merges on failures; frontend work will surface an `npm run lint` script and ensure CI runs ESLint before reviews.
- **Testing**: New pytest coverage will target upload validation, Hafnia API client handling, and error states; each PR will include passing results from `uv run pytest -k "video_summary"` and reviewers will reject alternative runners.
- **UV Usage**: All Python activities—dependency locking, running FastAPI locally, executing tests—will reference `uv lock`, `uv run uvicorn clipnotes.main:app --reload`, and `uv run pytest`, preventing `pip` or ad-hoc scripts from entering docs or automation.
- **Accessible UI**: Tailwind + shadcn/ui components (file uploader, status view, summary cards) will undergo keyboard navigation checks and axe or Lighthouse scans to document WCAG 2.1 AA compliance across primary flows.
- **Performance Budget**: The backend will log start/finish timestamps for Hafnia calls and expose a simple metric so QA can confirm 15–30 second clips complete in ≤10 seconds (target 5 seconds) during staging tests.
- **Credential Handling**: `HAFNIA_API_KEY` and related secrets will load from environment variables only; `.env.example` will detail required keys and rotation process without embedding secrets in the repository.
- **Iteration Plan**: Delivery will proceed in day-sized slices (UI shell, upload plumbing, API integration, polish) with brief experiment notes captured in `specs/001-video-summary/research.md` so teammates can replay results quickly.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Upload clip and read summary (Priority: P1)

As an investigator reviewing footage, I want to upload a short clip and receive a concise summary so I can understand the scene without scrubbing the video.

**Why this priority**: Delivers the core value proposition and is mandatory for demoing ClipNotes.

**Independent Test**: `uv run pytest -k "test_upload_summary_success"` with a fixture clip under size/duration limits verifies the flow end-to-end.

**Acceptance Scenarios**:

1. **Given** I select a valid .mp4 shorter than 30 seconds, **When** I submit the upload, **Then** I see a loading indicator until a bullet-point summary renders.
2. **Given** the Hafnia API responds with JSON, **When** the summary arrives, **Then** I see a readable list preserving structured fields (e.g., timestamps or actors) in the UI.

---

### User Story 2 - Receive actionable feedback on invalid uploads (Priority: P2)

As a user preparing footage, I want immediate guidance if my clip is too large, too long, or the wrong format so I can correct it without retry loops.

**Why this priority**: Prevents wasted time during the hackathon demo and protects API quota from invalid submissions.

**Independent Test**: `uv run pytest -k "test_upload_summary_validation"` asserts validation errors surface before the backend calls the Hafnia API.

**Acceptance Scenarios**:

1. **Given** I attempt to upload a 120MB .mp4, **When** I submit, **Then** the UI shows a clear message that files must be under 100MB and blocks the request.
2. **Given** I choose a .avi file, **When** I upload, **Then** the system rejects it with acceptable formats listed.

---

### User Story 3 - Understand progress and errors during processing (Priority: P3)

As a viewer awaiting the summary, I want status updates and meaningful error messaging if the AI request fails so I know whether to retry or escalate.

**Why this priority**: Maintains trust and keeps demo momentum even when dependencies misbehave.

**Independent Test**: `uv run pytest -k "test_upload_summary_failure_paths"` simulates Hafnia timeouts and verifies the UI’s status transitions via mocked responses.

**Acceptance Scenarios**:

1. **Given** the Hafnia API times out, **When** the backend returns an error, **Then** I see an apology message with next steps (retry or contact support) and the loader stops spinning.
2. **Given** the backend completes successfully, **When** the summary renders, **Then** the UI records a timestamp of completion so I can reference it later in the session.

### Edge Cases

- Upload attempts over 100MB or beyond 30 seconds should be rejected client-side and server-side with matching error copy.
- Hafnia API returning partial or empty summaries must trigger a fallback message indicating the clip should be reviewed manually.
- Network interruptions during upload should not leave the UI in a stuck loading state; the user receives a retry prompt.
- Consecutive uploads in a single session should clear or clearly replace previous results so users know which clip each summary describes.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST allow users to select and upload .mp4 or .mkv files that are under 100MB and shorter than 30 seconds.
- **FR-002**: System MUST block submission of files that violate size, duration, or format limits and display inline guidance explaining the issue.
- **FR-003**: System MUST transmit accepted videos to the Hafnia VLM API with required metadata and capture the returned summary payload.
- **FR-004**: System MUST render the AI response as readable bullet points, formatting JSON responses with indentation and labels when applicable.
- **FR-005**: System MUST present a visible loading indicator during processing and prevent duplicate submissions until a result or error is shown.
- **FR-006**: System MUST log and surface API or network failures with user-facing remediation steps while recording diagnostics for developers.
- **FR-007**: System MUST load API credentials from environment variables on the server side only and ensure no secrets are exposed to the browser or repository.

### Constitutional Constraints *(mandatory)*

- **CC-001**: Document and enforce `uv run ruff check` for backend linting and `npm run lint` for frontend linting, with both commands wired into CI for this feature.
- **CC-002**: Add pytest coverage for successful, invalid, and failed upload scenarios and verify all suites with `uv run pytest` before merge.
- **CC-003**: Design Tailwind + shadcn/ui components with semantic roles, focus order, and contrast annotations, capturing accessibility evidence alongside the feature docs.
- **CC-004**: Instrument Hafnia request durations so QA can confirm 15–30 second clips complete within ≤10 seconds, documenting findings before release.
- **CC-005**: Reference required environment variables (e.g., `HAFNIA_API_KEY`, `HAFNIA_API_URL`) in `.env.example` while keeping actual values in secure storage.
- **CC-006**: Record experiment notes and iteration checkpoints in the feature documentation to maintain hackathon velocity and shared context.

### Key Entities *(include if feature involves data)*

- **VideoSubmission**: Captures client-provided filename, format, filesize, duration, and upload timestamp; links to processing status.
- **SummaryReport**: Stores structured summary text, bullet list items, optional JSON payload, and completion timestamp for presentation.
- **ProcessingStatus**: Tracks state transitions (idle, uploading, processing, success, error) and associated user-facing messages.

## Assumptions

- Users access ClipNotes through an authenticated but single-tenant interface, so per-user storage beyond the active session is out of scope.
- Hafnia VLM API accepts pre-signed upload URLs or direct file uploads as documented, and request quotas are sufficient for hackathon testing.
- Duration validation can rely on client-side metadata while the backend performs a secondary check based on transcoding or probe utilities.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95% of valid test uploads (mp4/mkv, <100MB, ≤30s) produce a summary visible to the user within 10 seconds of submission.
- **SC-002**: 90% of usability test participants report that the generated summary is understandable without replaying the video.
- **SC-003**: 100% of invalid upload attempts display corrective guidance within 2 seconds of submission without contacting the Hafnia API.
- **SC-004**: No API credentials or summaries are exposed in client logs or repository files during security review, with `.env.example` documenting required configuration.
